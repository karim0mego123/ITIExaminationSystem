
@{
    Layout = null;
}
@model List<InstructorStudentDto>
@functions {
    public string IsActive(string controller, string action)
    {
        var currentController = ViewContext.RouteData.Values["controller"]?.ToString();
        var currentAction = ViewContext.RouteData.Values["action"]?.ToString();

        return (currentController == controller && currentAction == action)
            ? "active"
            : "";
    }
}

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>ITI Instructor - Dashboard</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet" />
    <script src="https://unpkg.com/lucide@latest" defer></script>
    <link rel="icon" type="image/png" href="/images/Gemini_Generated_Image_vi5243vi5243vi52.png">
    <script src="https://unpkg.com/lucide@latest/dist/umd/lucide.js" defer></script>
    <link href="/css/Instructor.css" rel="stylesheet" />
    <style>
        /* Circular Button Styles */
        .carousel-btn-circle {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid #667eea;
            background: #214F72;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

            .carousel-btn-circle:hover:not(:disabled) {
                background: #214F72;
                transform: scale(1.1);
                box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            }

                .carousel-btn-circle:hover:not(:disabled) svg {
                    stroke: white;
                }

            .carousel-btn-circle:disabled {
                opacity: 0.4;
                cursor: not-allowed;
                border-color: ##214F72;
            }

                .carousel-btn-circle:disabled svg {
                    stroke: #ccc;
                }

            .carousel-btn-circle:active:not(:disabled) {
                transform: scale(0.95);
            }

        .carousel-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            margin: 20px 0;
        }

        .carousel-info {
            min-width: 120px;
            text-align: center;
        }

        .carousel-indicator {
            font-size: 14px;
            color: #666;
        }

        #currentPage, #totalPages {
            font-weight: 600;
            color: #667eea;
        }
    </style>
</head>
<body>
    <div id="dashboard-view">
        <header class="admin-header">
            <div class="header-left">
                <div class="nav-logo-box"></div>
                <span class="header-title">Instructor Portal</span>
            </div>

            <nav class="nav-links">
                <a asp-controller="Instructor"
                   asp-action="insDiplayStudents"
                   class="nav-link @IsActive("Instructor", "insDiplayStudents")">
                    Students
                </a>

                <a asp-controller="Instructor"
                   asp-action="Courses"
                   class="nav-link @IsActive("Instructor", "Courses")">
                    Courses
                </a>

                <a asp-controller="Instructor"
                   asp-action="Exams"
                   class="nav-link @IsActive("Instructor", "Exams")">
                    Exams
                </a>
            </nav>


            <a style="text-decoration: none;" href="/Home/LoginPage" id="logoutBtn" class="nav-link logout-btn">Logout</a>

        </header>

        <div class="bg-shapes">
            <div class="shape shape-1"></div>
            <div class="shape shape-2"></div>
            <div class="shape shape-3"></div>
        </div>

        <main class="main-content">
            <!-- Stats Cards -->
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">👨‍🎓</div>
                    <div class="stat-info">
                        <h3>Total Students</h3>
                        <p id="stat-students">@ViewBag.StudentCount</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">👨‍🏫</div>
                    <div class="stat-info">
                        <h3>Instructors</h3>
                        <p id="stat-instructors">@ViewBag.instractors</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">📚</div>
                    <div class="stat-info">
                        <h3>Active Courses</h3>
                        <p id="stat-courses">@ViewBag.CourseCount</p>
                    </div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">📝</div>
                    <div class="stat-info">
                        <h3>Exams Scheduled</h3>
                        <p>1</p>
                    </div>
                </div>
            </div>

            <!-- STUDENTS TAB -->
            <div id="tab-students" class="content-tab">
                <div class="data-panel">
                    <div class="panel-header">
                        <h2 class="panel-title">👨‍🎓 Student Management</h2>
                        <div class="header-controls">
                            <button class="btn-add" onclick="openModal('student')">
                                + Add Student
                            </button>
                        </div>
                    </div>

                    <!-- Carousel Navigation with Circular Buttons -->
                    <div class="carousel-controls">
                        <button class="carousel-btn-circle prev-btn" id="prevBtn" onclick="moveCarousel(-1)">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                                 stroke="#667eea" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="15 18 9 12 15 6"></polyline>
                            </svg>
                        </button>

                        <div class="carousel-info">
                            <span class="carousel-indicator">
                                Page <span id="currentPage">1</span> of <span id="totalPages">1</span>
                            </span>
                        </div>

                        <button class="carousel-btn-circle next-btn" id="nextBtn" onclick="moveCarousel(1)">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none"
                                 stroke="#667eea" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <polyline points="9 18 15 12 9 6"></polyline>
                            </svg>
                        </button>
                    </div>

                    <!-- Carousel Container -->
                    <div class="table-carousel-container">
                        <div class="table-carousel-wrapper" id="tableCarousel">
                            <!-- Table will be split into pages here -->
                            <div class="carousel-page active">
                                <table>
                                    <thead>
                                        <tr>
                                            <th></th>
                                            <th>ID</th>
                                            <th>Name</th>
                                            <th>Email</th>
                                            <th>Branch</th>
                                            <th>Track</th>
                                            <th class="select">
                                                Intake
                                            </th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="studentsTableBody">
                                        @foreach (var s in Model)
                                        {
                                            <tr class="ROWEDIT" data-user-id="@s.User_Id">
                                                <td></td>
                                                <td>@s.User_Id</td>
                                                <td style="font-weight: 600; color: #667eea">@s.User_Name</td>
                                                <td>@s?.User_Email</td>
                                                <td>
                                                    <span class="badge badge-purple">
                                                        @((ViewBag.Branches as List<Branch>)
                                                            ?.FirstOrDefault(b => b.BranchId == s.Branch_Id)
                                                            ?.BranchName)
                                                    </span>
                                                </td>
                                                <td>
                                                    <span class="badge badge-purple">
                                                        @((ViewBag.Tracks as List<Track>)
                                                            ?.FirstOrDefault(t => t.TrackId == s.Track_Id)
                                                            ?.TrackName)
                                                    </span>
                                                </td>
                                                <td style="text-align: center;">@s.Intake_Number</td>
                                                <td>
                                                    <button class="action-btn btn-edit"
                                                            onclick="openEditStudentModal(
                                            '@s.User_Id',
                                            '@s.User_Name',
                                            '@s?.User_Email',
                                            '@s.Branch_Id',
                                            '@s.Track_Id',
                                            '@s.Intake_Number')">
                                                        Edit
                                                    </button>
                                                    <button class="action-btn btn-delete"
                                                            data-user-id="@s.User_Id"
                                                            data-user-name="@s.User_Name"
                                                            data-user-email="@s.User_Email">
                                                        Delete
                                                    </button>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Carousel Dots Navigation -->
                    <div class="carousel-dots" id="carouselDots">
                        <!-- Dots will be generated by JavaScript -->
                    </div>

                
                </div>
            </div>
        </main>
    </div>

    <div id="modal-overlay" class="modal-overlay hidden">
        <div id="modal-student" class="modal-box hidden">
            <h2 class="modal-title">Add New Student</h2>
            <form asp-action="AddStudent" asp-controller="Instructor" method="post">
                <div id="step-1">
                    <div class="form-group">
                        <label>Student Name</label>
                        <input type="text" id="inp-stud-name" name="FullName" class="form-input" required placeholder="e.g. Ahmed Ali" />
                    </div>
                    <div class="form-group">
                        <label>Branch ID</label>
                        <input type="number" id="inp-stud-branch" name="Branch" class="form-input" required placeholder="Enter Branch ID" />
                    </div>
                    <div class="form-group">
                        <label>Track ID</label>
                        <input type="number" id="inp-stud-track" name="Track" class="form-input" required placeholder="Enter Track ID" />
                    </div>
                    <div class="form-group">
                        <label>Intake</label>
                        <input type="number" id="inp-stud-intake" name="Intake" class="form-input" required min="1" placeholder="e.g. 46" />
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn-cancel" onclick="closeModal()">Cancel</button>
                        <button type="button" class="btn-next action-btn" style="background: #4f46e5; color: white;" onclick="showStep2()">Next: Login Info →</button>
                    </div>
                </div>

                <div id="step-2" class="hidden">
                    <div class="banner-info" style="background: #e0e7ff; padding: 10px; border-radius: 6px; margin-bottom: 15px; color: #3730a3; font-size: 0.9em;">
                        ℹ️ Set the login credentials for this student.
                    </div>
                    <div class="form-group">
                        <label>Email (Username)</label>
                        <input type="email" id="inp-stud-email" name="Email" class="form-input" required placeholder="student@iti.gov.eg" />
                    </div>
                    <div class="form-group">
                        <label>Password</label>
                        <input type="password" name="Password" class="form-input" required placeholder="******" />
                    </div>
                    <div class="form-group">
                        <label>Confirm Password</label>
                        <input type="password" name="ConfirmPassword" class="form-input" required placeholder="******" />
                    </div>
                    <div class="modal-actions">
                        <button type="button" class="btn-cancel" onclick="showStep1()">← Back</button>
                        <button type="submit" class="btn-add">Create Account</button>
                    </div>
                </div>
            </form>
        </div>

        <div id="modal-edit-student" class="modal-box hidden">
            <h2 class="modal-title">Edit Student</h2>
            <form asp-action="UpdateStudent" asp-controller="Instructor" method="post">
                <input type="hidden" id="edit-stud-id" name="UserId" />
                <div class="form-group">
                    <label>Student Name</label>
                    <input type="text" id="edit-stud-name" name="FullName" class="form-input" required />
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="edit-stud-email" name="Email" class="form-input" required />
                </div>
                <div class="form-group">
                    <label>Branch</label>
                    <select id="edit-stud-branch"
                            name="Branch"
                            class="form-input"
                            required>
                        <option value="">-- Select Branch --</option>
                        @foreach (var branch in ViewBag.Branches)
                        {
                            <option value="@branch.BranchId">
                                @branch.BranchName
                            </option>
                        }
                    </select>
                </div>

                <div class="form-group">
                    <label>Track</label>
                    <select id="edit-stud-track"
                            name="Track"
                            class="form-input"
                            required>
                        <option value="">-- Select Track --</option>
                        @foreach (var track in ViewBag.Tracks)
                        {
                            <option value="@track.TrackId">
                                @track.TrackName
                            </option>
                        }
                    </select>
                </div>

                <div class="form-group">
                    <label>Intake</label>
                    <input type="number" id="edit-stud-intake" name="Intake" class="form-input" required />
                </div>
                <div class="modal-actions">
                    <button type="button" class="btn-cancel" onclick="closeModal()">Cancel</button>
                    <button asp-action="UpdateStudent" asp-controller="Instructor" class="btn btn-secondary">
                        Update Student
                    </button>
                </div>
            </form>
        </div>

        <div id="modal-delete-student" class="modal-box hidden delete-modal-container">
            <div class="icon-box">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
                    <line x1="12" y1="9" x2="12" y2="13"></line>
                    <line x1="12" y1="17" x2="12.01" y2="17"></line>
                </svg>
            </div>

            <h2>Delete Student</h2>
            <p class="confirm-text">Are you sure you want to delete</p>
            <strong class="target-text" id="delete-student-name">Student Name</strong>

            <p class="warning-details">
                This action cannot be undone. This will permanently delete the student account
                and remove all associated data from the system.
            </p>

            <form id="deleteStudentForm" method="post" asp-action="DeleteStudent" asp-controller="Instructor">
                <input type="hidden" id="delete-student-id" name="userId"
                />
                <div class="button-row">
                    <button type="button" class="btn-cancel" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn-delete-red">Delete Student</button>
                </div>
            </form>
        </div>
       
        <div id="modal-edit-course" class="modal-box hidden">
            <h2 class="modal-title">Edit Course</h2>

            <form onsubmit="handleEditCourse(event)">
                <input type="hidden" id="edit-course-id" />

                <div class="form-group">
                    <label>Course Name</label>
                    <input type="text" id="edit-course-name" class="form-input" required />
                </div>

                <div class="form-group">
                    <label>Instructor Name</label>
                    <input type="text" id="edit-course-inst" class="form-input" required />
                </div>

                <input type="hidden" id="edit-course-email" />

                <div class="form-group">
                    <label>Duration</label>
                    <input type="number" id="edit-course-dur" class="form-input" required />
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn-cancel" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn-add">Update Course</button>
                </div>
            </form>
        </div>


    </div>

    <script>
        // ===================================================================
        // COMPLETE CAROUSEL + BUTTON FIX JAVASCRIPT (WITH DELETE MODAL)
        // ===================================================================

        let currentCarouselPage = 1;
        let itemsPerPage = 6;
        let totalItems = 0;
        let allStudentRows = [];

        // ===================================================================
        // DEFINE openDeleteModal FIRST - BEFORE initializeDeleteButtons
        // ===================================================================

        function openDeleteModal(userId, userName, userEmail) {
            console.log('Opening delete modal for:', userId, userName);

            const modalOverlay = document.getElementById('modal-overlay');
            const deleteModal = document.getElementById('modal-delete-student');
            const studentNameElement = document.getElementById('delete-student-name');
            const studentIdInput = document.getElementById('delete-student-id');

            if (!modalOverlay || !deleteModal) {
                console.error('Delete modal elements not found');
                // Fallback to confirm dialog
                if (confirm(`Are you sure you want to delete ${userName}?`)) {
                    window.location.href = `/Instructor/DeleteStudent?id=${userId}`;
                }
                return;
            }

            // Set the student name and ID
            if (studentNameElement) {
                studentNameElement.textContent = userName;
            }

            if (studentIdInput) {
                studentIdInput.value = userId;
            }

            // Show modal
            modalOverlay.classList.remove('hidden');
            deleteModal.classList.remove('hidden');

            // Hide other modals
            document.querySelectorAll('.modal-box').forEach(modal => {
                if (modal.id !== 'modal-delete-student') {
                    modal.classList.add('hidden');
                }
            });
        }

        // Initialize everything on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded, initializing...');

            // Small delay to ensure all DOM is ready
            setTimeout(() => {
                initializeCarousel();
                initializeDeleteButtons();

                // Initialize Lucide icons
                if (typeof lucide !== 'undefined') {
                    lucide.createIcons();
                }
            }, 100);
        });

        // ===================================================================
        // CAROUSEL FUNCTIONS
        // ===================================================================

        function initializeCarousel() {
            const tbody = document.getElementById('studentsTableBody');

            if (!tbody) {
                console.error('studentsTableBody not found!');
                return;
            }

            // Get all student rows
            allStudentRows = Array.from(tbody.querySelectorAll('tr.ROWEDIT'));
            totalItems = allStudentRows.length;

            console.log(`Found ${totalItems} student rows`);

            if (totalItems === 0) {
                console.warn('No student data found');
                return;
            }

            // Render first page
            renderCarouselPage(1);
        }

        function renderCarouselPage(pageNumber) {
            currentCarouselPage = pageNumber;

            const totalPages = itemsPerPage === 'all'
                ? 1
                : Math.ceil(totalItems / itemsPerPage);

            // Update page indicators
            const currentPageEl = document.getElementById('currentPage');
            const totalPagesEl = document.getElementById('totalPages');

            if (currentPageEl) currentPageEl.textContent = currentCarouselPage;
            if (totalPagesEl) totalPagesEl.textContent = totalPages;

            let startIndex = 0;
            let endIndex = totalItems;

            if (itemsPerPage !== 'all') {
                startIndex = (currentCarouselPage - 1) * itemsPerPage;
                endIndex = Math.min(startIndex + itemsPerPage, totalItems);
            }

            // Show/hide rows
            allStudentRows.forEach((row, index) => {
                if (index >= startIndex && index < endIndex) {
                    row.style.display = ''; // Show row
                } else {
                    row.style.display = 'none'; // Hide row
                }
            });

            // Update navigation buttons
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');

            if (prevBtn) prevBtn.disabled = currentCarouselPage === 1;
            if (nextBtn) nextBtn.disabled = currentCarouselPage === totalPages;

            // Update dots navigation
            renderCarouselDots(totalPages);

            // Re-initialize Lucide icons for visible rows
            if (typeof lucide !== 'undefined') {
                lucide.createIcons();
            }
        }

        function moveCarousel(direction) {
            const totalPages = itemsPerPage === 'all'
                ? 1
                : Math.ceil(totalItems / itemsPerPage);
            const newPage = currentCarouselPage + direction;

            if (newPage >= 1 && newPage <= totalPages) {
                renderCarouselPage(newPage);
            }
        }

        function goToPage(pageNumber) {
            renderCarouselPage(pageNumber);
        }

        function renderCarouselDots(totalPages) {
            const dotsContainer = document.getElementById('carouselDots');

            if (!dotsContainer) return;

            dotsContainer.innerHTML = '';

            // Only show dots if there's more than 1 page
            if (totalPages <= 1) return;

            for (let i = 1; i <= totalPages; i++) {
                const dot = document.createElement('button');
                dot.className = 'carousel-dot' + (i === currentCarouselPage ? ' active' : '');
                dot.type = 'button'; // Prevent form submission
                dot.onclick = () => goToPage(i);
                dot.setAttribute('aria-label', `Go to page ${i}`);
                dotsContainer.appendChild(dot);
            }
        }


        // ===================================================================
        // DELETE BUTTONS
        // ===================================================================

        function initializeDeleteButtons() {
            // Use event delegation to handle delete button clicks
            document.addEventListener('click', function(e) {
                // Check if clicked element is a delete button or inside one
                const deleteBtn = e.target.closest('.btn-delete');

                if (deleteBtn) {
                    e.preventDefault();
                    e.stopPropagation();

                    const userId = deleteBtn.getAttribute('data-user-id');
                    const userName = deleteBtn.getAttribute('data-user-name');
                    const userEmail = deleteBtn.getAttribute('data-user-email');

                    console.log('Delete clicked for:', userId, userName);

                    // Call the delete modal function (NOW DEFINED ABOVE)
                    openDeleteModal(userId, userName, userEmail);
                }
            });
        }

        // ===================================================================
        // EDIT STUDENT MODAL
        // ===================================================================

        function openEditStudentModal(userId, userName, userEmail, branchId, trackId, intakeNumber) {
            console.log('Opening edit modal for:', userId);

            // Fill in the form fields
            const modalOverlay = document.getElementById('modal-overlay');
            const editModal = document.getElementById('modal-edit-student');

            if (!modalOverlay || !editModal) {
                console.error('Modal elements not found');
                return;
            }

            // Set form values
            document.getElementById('edit-stud-id').value = userId;
            document.getElementById('edit-stud-name').value = userName;
            document.getElementById('edit-stud-email').value = userEmail;
            document.getElementById('edit-stud-branch').value = branchId;
            document.getElementById('edit-stud-track').value = trackId;
            document.getElementById('edit-stud-intake').value = intakeNumber;

            // Show modal
            modalOverlay.classList.remove('hidden');
            editModal.classList.remove('hidden');

            // Hide other modals
            document.querySelectorAll('.modal-box').forEach(modal => {
                if (modal.id !== 'modal-edit-student') {
                    modal.classList.add('hidden');
                }
            });
        }

        // ===================================================================
        // MODAL FUNCTIONS
        // ===================================================================

        function openModal(type) {
            const modalOverlay = document.getElementById('modal-overlay');
            const modal = document.getElementById('modal-' + type);

            if (modalOverlay && modal) {
                modalOverlay.classList.remove('hidden');
                modal.classList.remove('hidden');

                // Hide other modals
                document.querySelectorAll('.modal-box').forEach(m => {
                    if (m.id !== 'modal-' + type) {
                        m.classList.add('hidden');
                    }
                });
            }
        }

        function closeModal() {
            const modalOverlay = document.getElementById('modal-overlay');

            if (modalOverlay) {
                modalOverlay.classList.add('hidden');

                // Hide all modal boxes
                document.querySelectorAll('.modal-box').forEach(modal => {
                    modal.classList.add('hidden');
                });
            }

            // Reset to step 1 if multi-step form
            showStep1();
        }

        function showStep1() {
            const step1 = document.getElementById('step-1');
            const step2 = document.getElementById('step-2');

            if (step1) step1.classList.remove('hidden');
            if (step2) step2.classList.add('hidden');
        }

        function showStep2() {
            const step1 = document.getElementById('step-1');
            const step2 = document.getElementById('step-2');

            if (step1) step1.classList.add('hidden');
            if (step2) step2.classList.remove('hidden');
        }

        // ===================================================================
        // KEYBOARD NAVIGATION
        // ===================================================================

        document.addEventListener('keydown', function(e) {
            // Only navigate if not typing in an input
            if (e.target.tagName !== 'INPUT' &&
                e.target.tagName !== 'TEXTAREA' &&
                e.target.tagName !== 'SELECT') {

                if (e.key === 'ArrowLeft') {
                    moveCarousel(-1);
                } else if (e.key === 'ArrowRight') {
                    moveCarousel(1);
                } else if (e.key === 'Escape') {
                    closeModal();
                }
            }
        });

        // ===================================================================
        // CLOSE MODAL ON OVERLAY CLICK
        // ===================================================================

        document.addEventListener('click', function(e) {
            if (e.target.id === 'modal-overlay') {
                closeModal();
            }
        });

        console.log('Carousel script loaded successfully');
    </script>
</body>
</html>
